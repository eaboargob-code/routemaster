rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthed() {
      return request.auth != null;
    }

    function me() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function myData() {
      return me().data;
    }

    function myRole() {
      return myData().role;
    }

    function mySchoolId() {
      return myData().schoolId;
    }

    function isAdmin() {
      return isAuthed() && myRole() == "admin";
    }

    // --- Collection Rules ---

    match /users/{uid} {
      // Admins can read/write any user within their school.
      // Users can read their own data.
      allow read: if (isAdmin() && mySchoolId() == resource.data.schoolId) ||
                     (isAuthed() && request.auth.uid == uid);
      allow write: if isAdmin() && mySchoolId() == request.resource.data.schoolId;
    }

    match /routes/{routeId} {
      // Admins can read/write routes within their own school.
      allow read, write: if isAdmin() && mySchoolId() == resource.data.schoolId;
    }

    match /buses/{busId} {
      // Admins can read/write buses within their own school.
      allow read, write: if isAdmin() && mySchoolId() == resource.data.schoolId;
    }
  }
}